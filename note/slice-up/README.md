# 重関係の基礎演算子


このノートでは、関係の一部の項目から重関係をつくる `nest` と、
それをもとの関係にもどす `unnest` を、
より基礎的な演算子を使って定義してみましょう。
基礎的な演算子とは、組ごとの重関係をつくる `slice` と
その重関係を引き上げる演算子 `up` です。

入出力リスト [INOUT.k] に、このノートの使用例が一覧されています。


slice と up
------------------------------------------------------------------

まず、演算子 `slice` と `up` の使用例をみておきましょう。
[DATA.k] で定義されている項目 `/a` `/b` `/c` からなる
関係 `p` を例に使います。

```
p : source P /a /b /c

|-- P  /a 10  /b 40  /c 80
|-- P  /a 10  /b 50  /c 90
|-- P  /a 20  /b 60  /c 70
```

[slice.k] の計算式のように、この `p` を `slice /r` すると、

```
/a 10  /b 40  /c 80  /r {| /a : /b : /c | 10 : 40 : 80 |}
/a 10  /b 50  /c 90  /r {| /a : /b : /c | 10 : 50 : 90 |}
/a 20  /b 60  /c 70  /r {| /a : /b : /c | 20 : 60 : 70 |}
```

が得られ、この `/r` の内容を `up` すると、もとに戻ります。
`up /r` は `/r` 以外の項目 `/a` `/b` `/c` を捨てます。

```
/a 10  /b 40  /c 80
/a 10  /b 50  /c 90
/a 20  /b 60  /c 70
```


nest
------------------------------------------------------------------

つぎに `nest` の計算をみてみます。
関係 `p` の項目 `/b` と `/c` を入れ子にした
`/g` をつくる `nest /b /c -to /g` を計算すると、
つぎの重関係が得られます。
この計算は [nest.k] に記載されています。

```
/a 10  /g {| /b : /c | 40 : 80 | 50 : 90 |}
/a 20  /g {| /b : /c | 60 : 70 |}
```

この重関係を得るには、まず、`p` を `cut /b /c` した残りの

```
/a 10
/a 20
```

を `slice` します。

```
/a 10  /g {| /a : 10 |}
/a 20  /g {| /a : 20 |}
```

この `/g` の内容と `p` の交わりを計算すると、つぎのようになります。

```
/a 10  /g {| /a : /b : /c | 10 : 40 : 80 | 10 : 50 : 90 |}
/a 20  /g {| /a : /b : /c | 20 : 60 : 70 |}
```

さらに `pick /b /c` すると、
`nest` と同等の結果が得られます。

```
/a 10  /g {| /b : /c | 40 : 80 | 50 : 90 |}
/a 20  /g {| /b : /c | 60 : 70 |}
```



unnest
------------------------------------------------------------------

最後に `unnest` の計算をみてみます。
`nest /b /c -to /g` でつくった重関係を
もとにもどすには、`unnest /g` とします。
この計算は [unnest.k] に記載されています。

上の節の最後の重関係

```
/a 10  /g {| /b : /c | 40 : 80 | 50 : 90 |}
/a 20  /g {| /b : /c | 60 : 70 |}
```

を `slice /r` して、`cut /g` しておきます。

```
/a 10  /g {| /b : /c | 40 : 80 | 50 : 90 |}  /r {| /a | 10 |}
/a 20  /g {| /b : /c | 60 : 70 |}            /r {| /a | 20 |}
```

`/r` の内容に対して、`/g` の内容との交わりを計算します。
`nest` して `unnest` するときは、必ず、直積になる、
つまり、共有項目はもちません。
もし、`/g` の内容が編集されており、共有項目をもつときは、
交わり可能な組だけを残すという方法と、
項目の整合性に関するエラーとして扱う方法があります。

```
/a 10  /g {| /b : /c | 40 : 80 | 50 : 90 |}  /r {| /a : /b : /c | 10 : 40 : 80 | 10 : 50 : 90 |}
/a 20  /g {| /b : /c | 60 : 70 |}            /r {| /a : /b : /c | 20 : 60 : 70 |}
```

`up /r` して、`/a` と `/g` を捨てて、
`/r` の内容からなる関係に変換します。

```
{| /a : /b : /c | 10 : 40 : 80 | 10 : 50 : 90 | 20 : 60 : 70 |}
```

つまり、

```
/a 10  /b 40  /c 80
/a 10  /b 50  /c 90
/a 20  /b 60  /c 70
```

という、もとの関係が得られます。



[INOUT.k]:   script/INOUT.k
[DATA.k]:    script/DATA.k
[slice.k]:   script/slice.k
[nest.k]:    script/nest.k
[unnest.k]:  script/unnest.k

